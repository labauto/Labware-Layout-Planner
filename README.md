# Overview of the project

Please see the poster './poster.pdf' for the overview of this repository. The main idea is to determine the initial positions of reagents and labware by an experimental protocol (called `process flow`) written in natural language using Python and LLMs.

## How to run

1. Prepare Python and run `pip install -r requirements.txt`
2. Set **`process flow`** in `config.py` defined as `PROCESS_FLOW` variable (It's just text containing the process flow written in natural language)

3. Run `main_loop.py`
4. See the results in `./results/`
   
Some of the example results are stored in our private [Google Drive](https://drive.google.com/drive/u/1/folders/1E2nqOR9_0m0GdCLmeo0qKfpWyDqA6-y1).
> [!NOTE]
> The positions to put labware are currently fixed (Stations1 to Stations12) as in Opentrons OT2

## Contents of `./results/`

Each folder contains the results of one `main_loop.py` run

- `./results/<uuid>_iteration_<iteration_number>/`
  - contains the results of the iteration `<iteration_number>` of the run with the uuid `<uuid>`
- `/process_flow.txt'`
  - contains the process flow of the experiment defined in `config.py` and `inputs.py`
- `/initial_position.txt'`
  - contains the initial position of the agents and labwares
- `/obj_chan/object_list.json`
  - contains the list of objects extracted from the process flow using the `obj_chan` module (LLMs)
- `/haichi_chan/haichi.json`
  - contains the candidates of initial positions of the agents and labwares generated by the `haichi_chan` module
- `/code_chan/*`
  - contains the code generated by the `code_chan` module for Opentrons OT2 (Python)
- `/opentrons_simulate/`
  - contains the results of the simulation of the code generated by the `code_chan` module for Opentrons OT2 (Python)
- `/check_chan/check_chan_result.json`
  - contains the results of the check of the simulation results by the `check_chan` module

## Obj-chan

Extract object (reagents, labware) list from the process flow written in natural language.

Example:

Process flow:

```txt
1) Transfer 100 µL of hMSC cell suspension from a 1.5 mL tube to each well in a 96 well plate.
2) Transfer 200 µL DMEM medium from a 15 mL tube to each well in the 96 well plate.
3) Gently mix the contents of each well.
```

Object list:

```json
[
  {
    "name": "1.5 mL tube",
    "quantity": 1,
    "init_content": "hMSC cell suspension",
    "labware": { "id": 1, "name": "1.5_ml_tube" }
  },
  {
    "name": "15 mL tube",
    "quantity": 1,
    "init_content": "DMEM medium",
    "labware": { "id": 3, "name": "15_ml_tube" }
  },
  {
    "name": "96 well plate",
    "quantity": 1,
    "init_content": "",
    "labware": { "id": 2, "name": "96_well_plate" }
  }
]
```

## Haichi-chan

Given the station list, restricted station list for certain objects, and the object list, generate the candidates of initial positions of the agents and labwares.

Example:
Station list (OT2)
```python
stations = [f"Station{i}" for i in range(12)]
```

Restricted station list for certain objects (This is currently randomly determined by the below function)

````python
{
    "PBS": ["Station1"],
    "15% paraformaldehyde": ["Station2"],
    "0.2% Triton X-100/PBS": ["Station3"],
    "Blocking One": ["Station4"],
    "rabbit anti-ZO-1": ["Station5"],
    "mouse anti-MiTF": ["Station6"],
    "Alexa Fluor 546 Goat Anti-mouse IgG": ["Station7"],
    "Alexa Fluor 488 Goat Anti-rabbit IgG": ["Station8"],
    "DAPI": ["Station9"],
    "IX73 inverted microscope": ["Station10"],
}

# the above is generated by the following function defined in functions.py
def _generate_restricted_stations(stations: list, object_list: List[ObjchanObject]) -> dict:
    """
    For now, we assume random restricted stations to the objects.

    Generate a dict that contains (object name, station name) pairs such as:
    ```json
    {
        "96 well plate": [],
        "1.5 mL tube": [],
        "15 mL tube": []
    }
    ```
    from object_list and stations.
    """
    restricted_stations = {}
    station_number = 1
    for idx, object in enumerate(object_list):
        if idx > 12:
            station_number = 1
        restricted_stations[object.name] = [f"Station{station_number}"]
        station_number += 1
    print(f'*'*100)
    print(f'Generate restricted_stations: {restricted_stations}')
    print(f'*'*100)
    return restricted_stations
````

Initial position candidates

```json
[
  {
    "15 mL tube": "Station11",
    "96 well plate": "Station8",
    "1.5 mL tube": "Station10"
  },
  {
    "15 mL tube": "Station11",
    "96 well plate": "Station9",
    "1.5 mL tube": "Station0"
  },
  {
    "15 mL tube": "Station11",
    "96 well plate": "Station9",
    "1.5 mL tube": "Station1"
  },
  {
    "15 mL tube": "Station11",
    "96 well plate": "Station9",
    "1.5 mL tube": "Station2"
  },
    ...
]
```

The picked initial position from the candidates
```json
  {
    "15 mL tube": "Station11",
    "96 well plate": "Station8",
    "1.5 mL tube": "Station10"
  }
```

## Code-chan

Opentrons OT2 用のコードを生成する。
See https://arxiv.org/abs/2304.10267 for the details, or just ask LLM to generate python script for OT2.

## Check-chan
